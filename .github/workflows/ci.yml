name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    permissions:
      id-token: write  # Required for OIDC authentication with Codecov
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13', '3.14']
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b  # stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          workspaces: rust

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244  # v7.1.4

      - name: Install dependencies
        run: uv sync --all-extras --all-groups

      - name: Build Rust extension
        run: uv run maturin develop

      - name: Run tests
        # Coverage threshold: 92.5% (adjusted from 93% after exhaustive testing)
        # Remaining 0.5% consists of defensive exception handlers and edge cases
        # that are unreachable through public API without mocking internals.
        # See COVERAGE_ANALYSIS.md for detailed justification.
        run: uv run pytest tests/ --cov=dioxide --cov-report=xml --cov-report=term-missing --cov-branch --cov-fail-under=92.5 -v

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de  # v5.5.2
        with:
          use_oidc: true  # Use OIDC authentication instead of token
          files: ./coverage.xml
          flags: python-${{ matrix.python-version }}
          name: dioxide
          fail_ci_if_error: false

  # =============================================================================
  # BDD Test Suite (Behave/Gherkin)
  # =============================================================================
  # Three-tier BDD testing strategy:
  # 1. Regression Suite: All completed features (excludes @wip)
  # 2. Feature Acceptance: Current issue's tests (fails if @wip present)
  # 3. Pending Features: WIP tests (informational, non-blocking)
  # =============================================================================

  bdd-regression:
    name: BDD Regression Suite
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b  # stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          workspaces: rust

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244  # v7.1.4

      - name: Install dependencies
        run: uv sync --all-extras --all-groups

      - name: Build Rust extension
        run: uv run maturin develop

      - name: Run BDD Regression Suite
        run: uv run behave --tags="not @wip" --format=progress

  bdd-feature-acceptance:
    name: BDD Feature Acceptance
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Extract issue number from branch
        id: extract-issue
        env:
          # Use environment variables for branch names (security best practice)
          HEAD_REF: ${{ github.head_ref }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          BRANCH_NAME="${HEAD_REF:-$REF_NAME}"
          echo "Branch: $BRANCH_NAME"

          # Extract issue number from branch name (e.g., issue-42-description, feat/issue-42-desc)
          # Only digits are captured, preventing injection
          if [[ "$BRANCH_NAME" =~ issue-([0-9]+) ]]; then
            ISSUE_NUM="${BASH_REMATCH[1]}"
            echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
            echo "has_issue=true" >> $GITHUB_OUTPUT
            echo "Extracted issue number: $ISSUE_NUM"
          else
            echo "has_issue=false" >> $GITHUB_OUTPUT
            echo "No issue number found in branch name - skipping feature acceptance"
          fi

      - name: Setup Rust
        if: steps.extract-issue.outputs.has_issue == 'true'
        uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b  # stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        if: steps.extract-issue.outputs.has_issue == 'true'
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          workspaces: rust

      - name: Setup Python
        if: steps.extract-issue.outputs.has_issue == 'true'
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0
        with:
          python-version: '3.13'

      - name: Install uv
        if: steps.extract-issue.outputs.has_issue == 'true'
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244  # v7.1.4

      - name: Install dependencies
        if: steps.extract-issue.outputs.has_issue == 'true'
        run: uv sync --all-extras --all-groups

      - name: Build Rust extension
        if: steps.extract-issue.outputs.has_issue == 'true'
        run: uv run maturin develop

      - name: Check for @wip tag on issue tests
        if: steps.extract-issue.outputs.has_issue == 'true'
        env:
          ISSUE_NUM: ${{ steps.extract-issue.outputs.issue_number }}
        run: |
          ISSUE_TAG="@issue-${ISSUE_NUM}"

          echo "Checking for @wip tag on tests tagged with $ISSUE_TAG"

          # Find feature files with both @issue-XX and @wip tags
          # This uses behave's dry-run to check what would match
          if uv run behave --dry-run --tags="${ISSUE_TAG}" --tags="@wip" --format=json 2>/dev/null | grep -q '"status": "untested"'; then
            echo "::error::Found @wip tag on tests for issue #${ISSUE_NUM}. Remove @wip before merging."
            echo ""
            echo "Tests still marked as @wip:"
            uv run behave --dry-run --tags="${ISSUE_TAG}" --tags="@wip" --format=progress 2>&1 || true
            exit 1
          fi

          echo "No @wip tags found on issue #${ISSUE_NUM} tests - checking if tests exist and pass"

      - name: Run Feature Acceptance tests
        if: steps.extract-issue.outputs.has_issue == 'true'
        env:
          ISSUE_NUM: ${{ steps.extract-issue.outputs.issue_number }}
        run: |
          ISSUE_TAG="@issue-${ISSUE_NUM}"

          # Check if any tests exist for this issue
          if uv run behave --dry-run --tags="${ISSUE_TAG}" --format=json 2>/dev/null | grep -q '"status": "untested"'; then
            echo "Running acceptance tests for issue #${ISSUE_NUM}"
            uv run behave --tags="${ISSUE_TAG}" --format=progress
          else
            echo "No tests tagged with $ISSUE_TAG - skipping (this is OK for non-feature work)"
          fi

      - name: Skip notice for non-issue branches
        if: steps.extract-issue.outputs.has_issue != 'true'
        run: |
          echo "::notice::Skipped BDD Feature Acceptance - branch name does not contain issue number"
          echo "Branch naming convention: issue-XX-description (e.g., issue-42-add-caching)"

  bdd-pending:
    name: BDD Pending Features
    runs-on: ubuntu-latest
    continue-on-error: true  # Informational only - does not block merge

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b  # stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          workspaces: rust

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244  # v7.1.4

      - name: Install dependencies
        run: uv sync --all-extras --all-groups

      - name: Build Rust extension
        run: uv run maturin develop

      - name: Run BDD Pending Features
        run: |
          echo "Running @wip tests (informational - failures expected)"
          uv run behave --tags="@wip" --format=progress || true
          echo ""
          echo "::notice::Pending features shown above are work-in-progress and expected to fail"

  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244  # v7.1.4

      - name: Install dependencies
        run: uv sync --all-extras --all-groups

      - name: Check formatting
        run: uv run ruff format --check python/

      - name: Lint
        run: uv run ruff check python/ tests/

      - name: Check imports
        run: uv run isort python/ tests/ --check-only

      - name: Type check
        run: uv run mypy python/ tests/

  lint-rust:
    name: Lint Rust
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b  # stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          workspaces: rust

      - name: Check formatting
        run: cargo fmt --all --check
        working-directory: rust

      - name: Lint
        run: cargo clippy --all-targets --all-features -- -D warnings -A non-local-definitions
        working-directory: rust

  docs:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b  # stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
        with:
          workspaces: rust

      - name: Setup Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244  # v7.1.4

      - name: Cache uv dependencies
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7  # v5.0.2
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-docs-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-docs-
            ${{ runner.os }}-uv-

      - name: Install all dependencies including docs
        run: uv sync --all-extras --group docs

      - name: Build Rust extension
        run: uv run maturin develop

      - name: Build documentation
        run: uv run sphinx-build -b html docs docs/_build/html

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: documentation
          path: docs/_build/html
          retention-days: 7

  docs-linkcheck:
    name: Check Documentation Links
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b  # stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1  # v2.8.1
        with:
          workspaces: rust

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41  # v7.1.2

      - name: Cache uv dependencies
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7  # v5.0.2
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-linkcheck-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-linkcheck-
            ${{ runner.os }}-uv-

      - name: Install all dependencies including docs
        run: uv sync --all-extras --group docs

      - name: Build Rust extension
        run: uv run maturin develop

      - name: Check links
        run: uv run sphinx-build -b linkcheck docs docs/_build/linkcheck

      - name: Upload linkcheck report
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: linkcheck-report
          path: docs/_build/linkcheck/output.txt
          retention-days: 7
