name: Release (Automated)

on:
  push:
    branches:
      - main
    tags:
      - 'v*'  # Trigger on version tags (v0.0.2-alpha, v1.0.0, etc.)
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  issues: write
  pull-requests: write

jobs:
  determine-release:
    name: Determine Release Method
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
      tag: ${{ steps.check.outputs.tag }}
    steps:
      - id: check
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  # Phase 1 Fix: Pre-flight version validation
  # Validates that Cargo.toml version matches git tag BEFORE building wheels
  # Prevents wasting 90+ minutes building wrong version (issue #137)
  validate-version:
    name: Validate Version Synchronization
    needs: determine-release
    runs-on: ubuntu-latest
    if: needs.determine-release.outputs.should_release == 'true'
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
        with:
          ref: ${{ needs.determine-release.outputs.tag }}

      - name: Validate Cargo.toml version matches git tag
        run: |
          # Extract version from Cargo.toml
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d'"' -f2)

          # Extract version from git tag (remove 'v' prefix)
          TAG_VERSION="${{ needs.determine-release.outputs.version }}"

          echo "Cargo.toml version: $CARGO_VERSION"
          echo "Git tag version: $TAG_VERSION"

          if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
            echo ""
            echo "❌ ERROR: Version mismatch detected!"
            echo ""
            echo "  Cargo.toml:  $CARGO_VERSION"
            echo "  Git tag:     $TAG_VERSION"
            echo ""
            echo "This mismatch would cause building the wrong version."
            echo "Please update Cargo.toml to match the git tag before releasing."
            echo ""
            echo "To fix:"
            echo "  1. Update version in Cargo.toml to $TAG_VERSION"
            echo "  2. Commit the change"
            echo "  3. Move the git tag: git tag -f ${{ needs.determine-release.outputs.tag }}"
            echo "  4. Force push the tag: git push -f origin ${{ needs.determine-release.outputs.tag }}"
            exit 1
          fi

          echo "✅ Version validation passed: $CARGO_VERSION"

  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: determine-release
    # DISABLED: Using manual tagging for all releases (alpha + stable)
    # Will re-enable for stable releases only after MLP complete
    if: false
    concurrency: release
    outputs:
      released: ${{ steps.release.outputs.released }}
      version: ${{ steps.release.outputs.version }}
      tag: ${{ steps.release.outputs.tag }}

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41  # v7.1.2

      - name: Install dependencies
        run: uv sync --group dev

      - name: Python Semantic Release
        id: release
        uses: python-semantic-release/python-semantic-release@v10.5.1
        with:
          github_token: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}
          git_committer_name: "github-actions[bot]"
          git_committer_email: "github-actions[bot]@users.noreply.github.com"

  build-wheels:
    name: Build wheels on ${{ matrix.platform || matrix.os }} for ${{ matrix.target }}
    needs: [determine-release, semantic-release, validate-version]
    if: |
      always() && (
        needs.determine-release.outputs.should_release == 'true' ||
        needs.semantic-release.outputs.released == 'true'
      )
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux
            python-version: '3.14'
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux
            python-version: '3.13'
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux
            python-version: '3.11'

          # Linux aarch64 (ARM64)
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            platform: linux
            python-version: '3.14'
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            platform: linux
            python-version: '3.13'
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            platform: linux
            python-version: '3.11'

          # macOS x86_64 (Intel)
          - os: macos-13  # Intel runner
            target: x86_64-apple-darwin
            platform: macos
            python-version: '3.14'

          # macOS aarch64 (Apple Silicon)
          - os: macos-14  # M1 runner
            target: aarch64-apple-darwin
            platform: macos
            python-version: '3.14'

          # Windows x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            python-version: '3.14'
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            python-version: '3.13'
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            python-version: '3.11'

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
        with:
          ref: ${{ needs.determine-release.outputs.tag || needs.semantic-release.outputs.tag }}

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@6d653acede28d24f02e3cd41383119e8b1b35921  # stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      # For Linux ARM64 cross-compilation
      - name: Setup QEMU
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130  # v3.7.0
        with:
          platforms: arm64

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1  # v2.8.1
        with:
          workspaces: rust
          key: ${{ matrix.target }}-${{ matrix.python-version }}

      - name: Build wheels
        uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380  # v1.49.4
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --interpreter python${{ matrix.python-version }}
          manylinux: auto  # Use manylinux_2_28 where available
          docker-options: -e CI  # Pass CI env to docker

      - name: Upload wheels
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: wheels-${{ matrix.platform }}-${{ matrix.target }}-py${{ matrix.python-version }}
          path: dist/*.whl
          if-no-files-found: error

  build-sdist:
    name: Build source distribution
    needs: [determine-release, semantic-release, validate-version]
    if: |
      always() && (
        needs.determine-release.outputs.should_release == 'true' ||
        needs.semantic-release.outputs.released == 'true'
      )
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
        with:
          ref: ${{ needs.determine-release.outputs.tag || needs.semantic-release.outputs.tag }}

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: '3.13'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@6d653acede28d24f02e3cd41383119e8b1b35921  # stable
        with:
          toolchain: stable

      - name: Build sdist
        uses: PyO3/maturin-action@86b9d133d34bc1b40018696f782949dac11bd380  # v1.49.4
        with:
          command: sdist
          args: --out dist

      - name: Upload sdist
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: sdist
          path: dist/*.tar.gz
          if-no-files-found: error

  # Phase 1 Fix: Wheel validation
  # Validates wheel structure BEFORE uploading to PyPI
  # Catches ZIP structure issues and trailing data (issue #137)
  validate-wheels:
    name: Validate Wheel Structure
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Download all wheels
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: '3.13'

      - name: Install validation tools
        run: pip install wheel check-wheel-contents

      - name: Validate wheel ZIP structure
        run: |
          python3 << 'EOF'
          import zipfile
          from pathlib import Path

          def validate_wheel(wheel_path):
              """Validate wheel ZIP structure and detect issues."""
              issues = []

              try:
                  # Test ZIP integrity
                  with zipfile.ZipFile(wheel_path, 'r') as zf:
                      bad_file = zf.testzip()
                      if bad_file:
                          issues.append(f"Corrupt file in ZIP: {bad_file}")

                  # Check for trailing data
                  with open(wheel_path, 'rb') as f:
                      data = f.read()

                  # Find End of Central Directory signature
                  eocd_sig = b'PK\x05\x06'
                  pos = data.rfind(eocd_sig)

                  if pos == -1:
                      issues.append("No EOCD signature found")
                  else:
                      # Calculate expected end position
                      comment_len = int.from_bytes(data[pos+20:pos+22], 'little')
                      eocd_end = pos + 22 + comment_len
                      trailing_bytes = len(data) - eocd_end

                      if trailing_bytes > 0:
                          issues.append(f"Trailing data after EOCD: {trailing_bytes} bytes")

                  # Verify version in filename matches expected
                  # (This is redundant with pre-flight check but good defense-in-depth)
                  if issues:
                      return False, issues
                  return True, []

              except Exception as e:
                  return False, [f"Exception during validation: {e}"]

          # Validate all wheels
          dist_dir = Path('dist')
          wheels = list(dist_dir.glob('*.whl'))

          print(f"Validating {len(wheels)} wheel(s)...")
          print()

          all_valid = True
          for wheel in sorted(wheels):
              valid, issues = validate_wheel(wheel)
              if valid:
                  print(f"✅ {wheel.name}")
              else:
                  print(f"❌ {wheel.name}")
                  for issue in issues:
                      print(f"   - {issue}")
                  all_valid = False

          print()
          if not all_valid:
              print("❌ Wheel validation FAILED")
              print()
              print("Wheels have structural issues that would cause PyPI upload to fail.")
              print("This is a bug in the wheel building process.")
              exit(1)

          print("✅ All wheels passed validation")
          EOF

      - name: Check wheel contents
        run: |
          # Use check-wheel-contents to validate wheel metadata
          for wheel in dist/*.whl; do
            echo "Checking $wheel..."
            check-wheel-contents "$wheel"
          done

  test-wheels:
    name: Test wheels on ${{ matrix.os }} with Python ${{ matrix.python-version }}
    needs: [build-wheels, validate-wheels]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.13', '3.14']

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41  # v7.1.2

      - name: Download wheels
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: Install wheel
        run: |
          # Let uv pip select the compatible wheel for this platform
          uv pip install --system --find-links=dist --no-index dioxide

      - name: Install test dependencies
        run: uv pip install --system pytest pytest-cov mypy

      - name: Run smoke tests
        run: python tests/smoke_test.py

      - name: Run tests
        run: pytest tests/ -v

  # REMOVED: Test PyPI staging
  # Test PyPI was CAUSING version burn problems, not preventing them!
  #
  # The problem: Test PyPI and Production PyPI are SEPARATE registries with the
  # SAME version-burn policy. Once a version is uploaded to Test PyPI (even if
  # deleted later), that version number is burned FOREVER on Test PyPI.
  #
  # This caused failures when:
  # 1. Test PyPI upload succeeded
  # 2. Production PyPI failed for any reason (trailing data, etc.)
  # 3. We'd have to bump the patch version just to release
  #
  # The fix: Skip Test PyPI for stable releases. Go straight to Production PyPI.
  # Test PyPI is only useful for testing the upload PROCESS, not the code.
  # If CI passes (tests, wheel validation), go directly to Production.

  # Pre-flight check: Verify version is available on PyPI before attempting upload
  check-pypi-availability:
    name: Check PyPI Version Availability
    needs: [determine-release, semantic-release, build-wheels, build-sdist, validate-wheels, test-wheels]
    runs-on: ubuntu-latest
    if: |
      always() && (
        needs.determine-release.outputs.should_release == 'true' ||
        needs.semantic-release.outputs.released == 'true'
      )
    steps:
      - name: Check if version exists on PyPI
        run: |
          VERSION="${{ needs.determine-release.outputs.version || needs.semantic-release.outputs.version }}"
          echo "Checking if dioxide $VERSION already exists on PyPI..."

          # Check PyPI JSON API for existing version
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/dioxide/$VERSION/json")

          if [ "$HTTP_CODE" = "200" ]; then
            echo ""
            echo "❌ ERROR: Version $VERSION already exists on PyPI!"
            echo ""
            echo "This version has already been published. You cannot reuse version numbers."
            echo ""
            echo "To fix:"
            echo "  1. Bump the version in Cargo.toml"
            echo "  2. Update CHANGELOG.md"
            echo "  3. Create a new tag"
            echo ""
            exit 1
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "✅ Version $VERSION is available on PyPI"
          else
            echo "⚠️  Unexpected response from PyPI API (HTTP $HTTP_CODE)"
            echo "Proceeding with upload attempt..."
          fi

  publish-pypi:
    name: Publish to PyPI (Production)
    needs: [determine-release, semantic-release, build-wheels, build-sdist, validate-wheels, test-wheels, check-pypi-availability]
    runs-on: ubuntu-latest
    if: |
      always() && (
        needs.determine-release.outputs.should_release == 'true' ||
        needs.semantic-release.outputs.released == 'true'
      )
    environment:
      name: pypi
      url: https://pypi.org/project/dioxide/
    permissions:
      id-token: write

    steps:
      - name: Download all wheels
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: Download sdist
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          pattern: sdist
          path: dist
          merge-multiple: true

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c  # v6.0.0
        with:
          python-version: '3.13'

      - name: Strip trailing data from wheels (PyPI validation fix)
        run: |
          python3 << 'EOF'
          import os
          import zipfile
          from pathlib import Path

          def strip_trailing_data(wheel_path):
              """Remove trailing NULL bytes after ZIP End of Central Directory.

              PyPI now rejects wheels with trailing data to prevent ZIP confusion attacks.
              Some wheel builders (including maturin on Windows) add trailing NULL bytes.

              See: https://blog.pypi.org/posts/2025-08-07-wheel-archive-confusion-attacks/
              """
              with open(wheel_path, 'rb') as f:
                  data = f.read()

              # Find End of Central Directory signature (last occurrence)
              eocd_sig = b'PK\x05\x06'
              pos = data.rfind(eocd_sig)

              if pos == -1:
                  print(f"  ⚠️  No EOCD found in {wheel_path.name}")
                  return False

              # EOCD is 22 bytes minimum + comment
              comment_len = int.from_bytes(data[pos+20:pos+22], 'little')
              eocd_end = pos + 22 + comment_len

              trailing_bytes = len(data) - eocd_end

              if trailing_bytes > 0:
                  print(f"  ✂️  {wheel_path.name}: Removing {trailing_bytes} trailing bytes")
                  # Write file without trailing data
                  with open(wheel_path, 'wb') as f:
                      f.write(data[:eocd_end])
                  return True
              else:
                  print(f"  ✓  {wheel_path.name}: No trailing data")
                  return False

          # Process all wheels
          dist_dir = Path('dist')
          wheels = list(dist_dir.glob('*.whl'))

          print(f"Checking {len(wheels)} wheel(s) for trailing data...")
          fixed = 0

          for wheel in sorted(wheels):
              if strip_trailing_data(wheel):
                  fixed += 1

          if fixed > 0:
              print(f"\n✅ Fixed {fixed} wheel(s)")
          else:
              print(f"\n✅ All wheels clean")
          EOF

      - name: Install maturin
        run: pip install maturin

      - name: Publish to PyPI with Trusted Publishing
        run: |
          # Maturin automatically uses OIDC when id-token: write is set
          # and MATURIN_PYPI_TOKEN is not provided
          maturin upload dist/*

  create-github-release:
    name: Create GitHub Release
    needs: [determine-release, semantic-release, publish-pypi]
    runs-on: ubuntu-latest
    if: |
      always() && (
        needs.determine-release.outputs.should_release == 'true' ||
        needs.semantic-release.outputs.released == 'true'
      )
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5.0.0
        with:
          ref: ${{ needs.determine-release.outputs.tag || needs.semantic-release.outputs.tag }}

      - name: Download all wheels
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: Download sdist
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          pattern: sdist
          path: dist
          merge-multiple: true

      - name: Extract changelog
        run: |
          VERSION=${{ needs.determine-release.outputs.version || needs.semantic-release.outputs.version }}
          if [ -f CHANGELOG.md ]; then
            sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | head -n -1 > release_notes.md
          else
            echo "Release $VERSION" > release_notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe  # v2.4.2
        with:
          tag_name: ${{ needs.determine-release.outputs.tag || needs.semantic-release.outputs.tag }}
          body_path: release_notes.md
          files: dist/*
          draft: false
          prerelease: false
          generate_release_notes: true
